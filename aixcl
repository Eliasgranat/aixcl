#!/usr/bin/env bash

set -e  # Exit on error
set -u  # Treat unset variables as an error
set -o pipefail  # Catch errors in pipelines

# Load environment variables from .env file
if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
fi

# Allow custom Docker Compose file via environment variable
COMPOSE_FILE=${COMPOSE_FILE:-docker-compose.yml}
COMPOSE_CMD="docker-compose -f $COMPOSE_FILE"
CONTAINER_NAME="open-webui"

# Source the autocomplete script if it exists
if [ -f "$(dirname "$0")/aixcl_completion.sh" ]; then
    source "$(dirname "$0")/aixcl_completion.sh"
fi

function start() {
    echo "Starting Docker Compose deployment..."
    
    if docker ps --format "{{.Names}}" | grep -q "$CONTAINER_NAME"; then
        echo "Services are already running. Use 'stop' first if you want to restart."
        exit 1
    fi
    
    echo "Pulling latest images..."
    $COMPOSE_CMD pull
    
    echo "Starting services..."
    $COMPOSE_CMD up -d
    
    echo "Waiting for services to be ready..."
    for i in {1..30}; do
        if curl -s -o /dev/null -w "%{http_code}" http://localhost:11434/api/version 2>/dev/null | grep -q "200" && \
           curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 2>/dev/null | grep -q "200" && \
           docker exec postgres pg_isready -U webui >/dev/null 2>&1; then
            echo "All services are up and running!"
            status
            return 0
        fi
        echo "Waiting for services to become available... ($i/30)"
        sleep 2
    done
    
    echo "Error: Services did not start properly within timeout period"
    status
    exit 1
}

function stop() {
    echo "Stopping Docker Compose deployment..."
    
    if ! docker ps --format "{{.Names}}" | grep -qE "$CONTAINER_NAME|ollama|postgres|pgadmin|watchtower"; then
        echo "Services are not running."
        return 0
    fi
    
    echo "Stopping services gracefully..."
    $COMPOSE_CMD down --remove-orphans
    
    echo "Waiting for containers to stop..."
    for i in {1..15}; do
        if ! docker ps --format "{{.Names}}" | grep -qE "$CONTAINER_NAME|ollama|postgres|pgadmin|watchtower"; then
            echo "All services stopped successfully."
            return 0
        fi
        echo "Waiting for services to stop... ($i/15)"
        sleep 2
    done
    
    echo "Warning: Services did not stop gracefully. Forcing shutdown..."
    $COMPOSE_CMD down --remove-orphans -v
    docker ps -q | xargs -r docker stop
    
    echo "All services have been stopped."
}

function restart() {
    echo "Restarting services..."
    stop
    sleep 5
    start
}

function logs() {
    echo "Fetching logs..."
    $COMPOSE_CMD logs --tail=0 --follow
}

function clean() {
    echo "Cleaning up Docker resources..."
    
    echo "Stopping all containers..."
    $COMPOSE_CMD down
    
    echo "Removing stopped containers..."
    docker container prune -f
    
    echo "Removing unused images..."
    docker image prune -a -f
    
    echo "Removing unused volumes (including PostgreSQL data)..."
    docker volume prune -f
    
    echo "Clean up complete."
}

function stats() {
    echo "Monitoring GPU resources..."
    
    if command -v pipx run nvitop &> /dev/null; then
        echo "GPU Statistics (refreshing every 2 seconds, press Ctrl+C to exit):"
        echo "-------------------"
        pipx run nvitop
    elif command -v nvidia-smi &> /dev/null; then
        echo "GPU Statistics (refreshing every 2 seconds, press Ctrl+C to exit):"
        echo "-------------------"
        watch -n 2 nvidia-smi
    else
        echo "GPU monitoring not available: nvitop or nvidia-smi commands not found"
        exit 1
    fi
}

function status() {
    echo "Checking services status..."
    
    echo "Container Status:"
    echo "----------------"
    if docker ps --format "{{.Names}}" | grep -q "$CONTAINER_NAME"; then
        echo "✅ Open WebUI container is running"
    else
        echo "❌ Open WebUI container is not running"
    fi
    
    if docker ps --format "{{.Names}}" | grep -q "ollama"; then
        echo "✅ Ollama container is running"
    else
        echo "❌ Ollama container is not running"
    fi

    if docker ps --format "{{.Names}}" | grep -q "postgres"; then
        echo "✅ PostgreSQL container is running"
    else
        echo "❌ PostgreSQL container is not running"
    fi

    if docker ps --format "{{.Names}}" | grep -q "pgadmin"; then
        echo "✅ pgAdmin container is running"
    else
        echo "❌ pgAdmin container is not running"
    fi

    if docker ps --format "{{.Names}}" | grep -q "watchtower"; then
        echo "✅ Watchtower container is running"
    else
        echo "❌ Watchtower container is not running"
    fi
    
    echo -e "\nService Health:"
    echo "----------------"
    
    if curl -s -o /dev/null -w "%{http_code}" http://localhost:11434/api/version 2>/dev/null | grep -q "200"; then
        echo "✅ Ollama API is responding"
    else
        echo "❌ Ollama API is not responding"
    fi
    
    echo -n "Open WebUI status: "
    WEBUI_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health 2>/dev/null)
    if [ "$WEBUI_STATUS" = "200" ]; then
        echo "✅ Open WebUI is responding (HTTP 200)"
    else
        echo "❌ Open WebUI is not responding (HTTP $WEBUI_STATUS)"
        echo "Checking container logs:"
        docker logs $CONTAINER_NAME --tail 5
    fi

    echo -n "PostgreSQL status: "
    if docker exec postgres pg_isready -U "${POSTGRES_USER:-admin}" >/dev/null 2>&1; then
        echo "✅ PostgreSQL is responding"
    else
        echo "❌ PostgreSQL is not responding"
        echo "Checking PostgreSQL logs:"
        docker logs postgres --tail 5
    fi

    echo -n "pgAdmin status: "
    PGADMIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5050 2>/dev/null)
    if [ "$PGADMIN_STATUS" = "200" ] || [ "$PGADMIN_STATUS" = "302" ]; then
        echo -e "✅ pgAdmin is responding (HTTP $PGADMIN_STATUS)\n"
    else
        echo -e "❌ pgAdmin is not responding (HTTP $PGADMIN_STATUS)\n"
        echo "Checking pgAdmin logs:"
        docker logs pgadmin --tail 5
    fi
}

function add() {
    if [ -z "$1" ]; then
        echo "Error: Model name is required"
        echo "Usage: $0 add <model-name> [<model-name> ...]"
        echo "Example: $0 add starcoder2:latest"
        echo "Example: $0 add starcoder2:latest nomic-embed-text:latest"
        return 1
    fi

    echo "Adding model: $1"
    
    if ! docker ps --format "{{.Names}}" | grep -q "ollama"; then
        echo "Error: Ollama container is not running. Please start the services first."
        return 1
    fi

    if docker exec ollama ollama pull "$1"; then
        echo "✅ Successfully added model: $1"
    else
        echo "❌ Failed to add model: $1"
        echo "Debug: Check if the model name is correct and the Ollama container is running."
        return 1
    fi
}

function remove() {
    if [ -z "$1" ]; then
        echo "Error: Model name is required"
        echo "Usage: $0 remove <model-name> [<model-name> ...]"
        echo "Example: $0 remove starcoder2:latest"
        echo "Example: $0 remove starcoder2:latest nomic-embed-text:latest"
        return 1
    fi

    echo "Removing model: $1"
    
    if ! docker ps --format "{{.Names}}" | grep -q "ollama"; then
        echo "Error: Ollama container is not running. Please start the services first."
        return 1
    fi

    if docker exec ollama ollama rm "$1"; then
        echo "✅ Successfully removed model: $1"
    else
        echo "❌ Failed to remove model: $1"
        echo "Debug: Check if the model name is correct and the Ollama container is running."
        return 1
    fi
}

function list() {
    echo "Listing installed models..."
    
    if ! docker ps --format "{{.Names}}" | grep -q "ollama"; then
        echo "Error: Ollama container is not running. Please start the services first."
        return 1
    fi

    docker exec ollama ollama list
}

function help_menu() {
    echo "Usage: $0 {start|stop|restart|logs|clean|stats|status|add|remove|list|help|install-completion}"
    echo "Commands:"
    echo "  start                Start the AIXCL stack"
    echo "  stop                 Stop the AIXCL stack"
    echo "  restart              Restart all services"
    echo "  logs                 Show logs for all containers"
    echo "  clean                Remove unused Docker containers, images, and volumes"
    echo "  stats                Show resource usage statistics"
    echo "  status               Check services status"
    echo "  add <model-name>     Add one or more LLM's"
    echo "  remove <model-name>  Remove one or more LLM's"
    echo "  list                 List all installed LLM's"
    echo "  help                 Show this help menu"
    echo "  install-completion   Install bash completion"
    exit 1
}

function install_completion() {
    echo "Installing bash completion for aixcl..."
    
    # Get the script directory
    SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
    COMPLETION_SCRIPT="${SCRIPT_DIR}/aixcl_completion.sh"
    
    if [[ ! -f "$COMPLETION_SCRIPT" ]]; then
        echo "Error: Completion script not found at $COMPLETION_SCRIPT"
        exit 1
    fi
    
    # Determine the appropriate completion directory
    if [[ -d "/etc/bash_completion.d" ]] && [[ -w "/etc/bash_completion.d" ]]; then
        # System-wide installation (requires write permission)
        COMPLETION_DIR="/etc/bash_completion.d"
    elif [[ -d "$HOME/.local/share/bash-completion/completions" ]]; then
        # User-specific installation (preferred)
        COMPLETION_DIR="$HOME/.local/share/bash-completion/completions"
    else
        # Create user directory if it doesn't exist
        COMPLETION_DIR="$HOME/.local/share/bash-completion/completions"
        mkdir -p "$COMPLETION_DIR"
    fi
    
    # Copy the completion script
    cp "$COMPLETION_SCRIPT" "$COMPLETION_DIR/aixcl"
    
    echo "Bash completion installed to $COMPLETION_DIR/aixcl"
    echo "To use it immediately, run: source $COMPLETION_DIR/aixcl"
    echo "It will be automatically loaded in new shell sessions."
    
    # Add to .bashrc if not already there
    if ! grep -q "source.*$COMPLETION_DIR/aixcl" "$HOME/.bashrc"; then
        # First remove any old entries to prevent duplicates
        if grep -q "Added by aixcl installer" "$HOME/.bashrc"; then
            # Create a temporary file without the old entries
            grep -v -A 3 "Added by aixcl installer" "$HOME/.bashrc" > "$HOME/.bashrc.tmp"
            # Remove any blank lines that might have been created
            sed -i '/^$/d' "$HOME/.bashrc.tmp"
            # Replace the original file
            mv "$HOME/.bashrc.tmp" "$HOME/.bashrc"
        fi
        
        # Now add the new entry
        echo "# Added by aixcl installer" >> "$HOME/.bashrc"
        echo "if [ -f \"$COMPLETION_DIR/aixcl\" ]; then" >> "$HOME/.bashrc"
        echo "    source \"$COMPLETION_DIR/aixcl\"" >> "$HOME/.bashrc"
        echo "fi" >> "$HOME/.bashrc"
        echo "Added sourcing to ~/.bashrc for persistent completion"
    else
        echo "Completion script already referenced in ~/.bashrc"
    fi
}

function main() {
    if [[ $# -lt 1 ]]; then
        help_menu
    fi

    case "$1" in
        start)
            start
            ;;
        stop)
            stop
            ;;
        restart)
            restart
            ;;
        logs)
            logs
            ;;
        clean)
            clean
            ;;
        stats)
            stats
            ;;
        status)
            status
            ;;
        add)
            shift  # Remove the 'add' command from the arguments
            for model in "$@"; do  # Loop through all remaining arguments
                add "$model"  # Call the add function for each model
            done
            ;;
        remove)
            shift  # Remove the 'remove' command from the arguments
            for model in "$@"; do  # Loop through all remaining arguments
                remove "$model"  # Call the remove function for each model
            done
            ;;
        list)
            list
            ;;
        help)
            help_menu
            ;;
        install-completion)
            install_completion
            ;;
        *)
            help_menu
            ;;
    esac
}

main "$@"